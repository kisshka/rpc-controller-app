@page "/"
@rendermode InteractiveServer
@using AntDesign.TableModels
@using System.ComponentModel.DataAnnotations
@using Microsoft.EntityFrameworkCore
@using RpcApp.Domain
@using RpcControllerClient.Models
@using System.Text
@using System.Globalization;
@inject ModalService ModalService;
@inject RpcClientContext RpcClientContext;
@inject Notifications notification;
@inject ConfirmService ComfirmService;


<PageTitle>Home</PageTitle>
<div>
    @if (alert != null)
    {
        @alert
    }
    @{
        HexToByteArray("F70000DCBFDAA401");
    }
    <div class="table">
        <Tabs OnTabClick="OnTabClick">
            <TabPane Tab="Устройства" >
                <DeviceTab @ref="_deviceTab"/>
            </TabPane>
            <TabPane Tab="Ученики">
                <Space Direction="SpaceDirection.Horizontal">
                    <SpaceItem>
                        <Search Placeholder="Введите Ф.И.О ученика" EnterButton="true" />
                    </SpaceItem>
                    <Button Type="ButtonType.Primary" OnClick="PupilCreateModal">
                        Добавить ученика
                    </Button>
                    <Modal Title="Добавление ученика" @bind-Visible="@_visibleModal" OnOk="HandleOk" OnCancel="HandleCancel">
                        @FormTemplate();
                    </Modal>
                </Space>
                <Table @ref="_pupilsTable" TItem="Pupils" PageSize="5" Total="_pupilsTotal" DataSource="_pupilsDataSource" OnChange="OnPupilsChange">
                    <PropertyColumn Property="c => c.SurnamePupil"></PropertyColumn>
                    <PropertyColumn Property="c => c.NamePupil"></PropertyColumn>
                    <PropertyColumn Property="c => c.PatronymicPupil"></PropertyColumn>
                    <PropertyColumn Property="c => c.CardNumber"></PropertyColumn>
                    <PropertyColumn Property="c => c.CardValidityPeriod">
                        @{
                            <p>@context.CardValidityPeriod.ToString("dd.MM.yyyy")</p>
                        }
                    </PropertyColumn>
                    <ActionColumn Title="Изменить/Удалить">
                        <a class="btn btn-primary" @onclick="() => EditPupil(context)">Изменить</a>
                        <a class="btn btn-danger" @onclick="() => DeletePupil(context)">Удалить</a>
                    </ActionColumn>
                </Table>
            </TabPane>
            <TabPane Tab="Посещения" Key="visitings">
                <VisitingsTab @ref="_visitingsTab" />
            </TabPane>
        </Tabs>
    </div>
</div>

@code {

    //Таблицы
    ITable _pupilsTable;


    // Данные для таблиц

    List<Pupils> _pupilsDataSource = new();


    // Общее количество записей

    int _pupilsTotal;


    private DeviceTab _deviceTab;
    private VisitingsTab _visitingsTab;

    #region Pupils
    async Task OnPupilsChange(QueryModel<Pupils> query)
    {
        var queryable = RpcClientContext.Pupils
        .AsQueryable();

        _pupilsTotal = queryable.Count();
        _pupilsDataSource = await queryable
            .ExecuteTableQuery(query)
            .CurrentPagedRecords(query)
            .ToListAsync();
    }
    #endregion

    #region InitializeData

    private RenderFragment? alert;

    private bool _initialized = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_initialized)
        {
            _initialized = true;

            alert = null;
            RequestSender requestSender = new RequestSender();

            try
            {
                var guid = requestSender.SetSubscribe();
                requestSender.SetConfigurationHwSrv(guid);
                alert = AlertSuccess();
            }
            catch (Exception e)
            {
                alert = AlertError();
                Console.WriteLine(e);
            }
            finally
            {
                await LoadInitialData();
                StateHasChanged();
            }
        }
    }

    private async Task OnTabClick(string key)
    {
        if (key == "visitings" && _visitingsTab != null)
        {
            await _visitingsTab.LoadVisitingsData();
        }
    }

    private async Task LoadInitialData()
    {
        await _deviceTab.LoadDevicesData();


        _pupilsDataSource = await RpcClientContext.Pupils
            .Take(5)
            .ToListAsync();
        _pupilsTotal = await RpcClientContext.Pupils.CountAsync();

        // await _visitingsTab.LoadVisitingsData();

        StateHasChanged();
    }

    void OnTabChange()
    {
        StateHasChanged();
    }
    #endregion

    #region ShortAndSearchMethods
    public string GetShortName(Pupils pupil)
    {
        if (pupil == null) return "Неизвестно";

        var surname = pupil.SurnamePupil ?? "";
        var nameInitial = pupil.NamePupil?.Length > 0 ? $"{pupil.NamePupil[0]}." : "";
        var patronymicInitial = pupil.PatronymicPupil?.Length > 0 ? $"{pupil.PatronymicPupil[0]}." : "";

        return $"{surname} {nameInitial}{patronymicInitial}";
    }
    #endregion


    #region CreateStudentInModal

    bool _visibleModal = false;

    Input<string> _inputCardNumber;

    Pupils pupil = new Pupils();

    private List<string> ClassNumber = new List<string>() { "1А", "1Б", "1В", "1Г",
                                                            "2А", "2Б", "2В", "2Г",
                                                            "3А", "3Б", "3В", "3Г",
                                                            "4А", "4Б", "4В", "4Г",
                                                            "5А", "5Б", "5В", "5Г",
                                                            "6А", "6Б", "6В", "6Г",
                                                            "7А", "7Б", "7В", "7Г",
                                                            "8А", "8Б", "8В", "8Г",
                                                            "9А", "9Б", "9В", "9Г",
                                                            "10А", "10Б", "10В", "10Г",
                                                            "11А", "11Б", "11В", "11Г"};
    bool _submitting = false;
    private Form<Pupils> _form;
    /// <summary>
    /// on modal OK button is click, submit form manually
    /// </summary>
    /// <param name="e"></param>
    private void HandleOk(MouseEventArgs e)
    {
        _submitting = true;
    }
    private void HandleCancel(MouseEventArgs e)
    {
        Console.WriteLine(e);
    }
    /// <summary>
    /// when form is submited, close the modal
    /// </summary>
    /// <param name="args"></param>
    private void OnFinish(EditContext editContext)
    {
        _submitting = false;
        _visibleModal = false;
        _form.Reset();
    }
    private void PupilCreateModal()
    {
        pupil.CardNumber = "";
        ModalRef modalRef = default;
        modalRef = ModalService.CreateModal(new()
        {
            Content = FormTemplate(),
            OnOk = async e =>
            {
                modalRef?.SetConfirmLoading(true);
                if (!_form.Validate())
                {
                    modalRef?.SetConfirmLoading(false);
                    return;
                }

                Pupils newPupil = new Pupils()
                {
                    SurnamePupil = pupil.SurnamePupil,
                    NamePupil = pupil.NamePupil,
                    PatronymicPupil = pupil.PatronymicPupil,
                    ClassNumber = pupil.ClassNumber,
                    CardNumber = pupil.CardNumber,
                    CardValidityPeriod = pupil.CardValidityPeriod
                };
                RpcClientContext.Pupils.Add(newPupil);
                RpcClientContext.SaveChanges();

                _form.Submit();

                await modalRef.CloseAsync();
                _form.Reset();

                _pupilsTable.ReloadData();
                StateHasChanged();
            },
            OnCancel = async e =>
            {
                if (!_form.IsModified || await ModalService.ConfirmAsync(new() { Content = "При выходе форма очистится и вы потеряете заполненные данные." }))
                {
                    await modalRef.CloseAsync();
                    _form.Reset();
                }
            },
        });
    }

    private string HEX = "HEX";
    private string DEX = "DEX";
    private string _encoding = "HEX";
    RenderFragment FormTemplate()
    {
        return
        @<Form Model="@pupil" OnFinish="OnFinish" @ref="@_form">
            <FormItem Label="Фамилия">
                <Input Placeholder="Введите фамилию ученика" @bind-Value="@context.SurnamePupil" />
            </FormItem>
            <FormItem Label="Имя">
                <Input Placeholder="Введите имя ученика" @bind-Value="@context.NamePupil" />
            </FormItem>
            <FormItem Label="Отчество">
                <Input Placeholder="Введите отчество ученика" @bind-Value="@context.PatronymicPupil" />
            </FormItem>
            <FormItem Label="Номер класса">
                <AutoComplete Placeholder="Введите класс ученика" @bind-Value="@context.ClassNumber" AllowFilter Options="@ClassNumber" FilterExpression="@((option, value) => option.Label.Contains(value ?? "", StringComparison.InvariantCultureIgnoreCase))" />
            </FormItem>
            <FormItem>
                Выберите формат считывания карты:
                <br />
                <RadioGroup @bind-Value="@_encoding">
                    <Radio Value="HEX">HEX</Radio>
                    <Radio Value="DEX">DEX</Radio>
                </RadioGroup>
            </FormItem>
            <FormItem Label="Номер карты">
                <Input Placeholder="Считайте карту" ReadOnly @ref="@_inputCardNumber" @bind-Value="@context.CardNumber" />
                <Button OnClick="ReadingCard" Type="ButtonType.Primary">Считать карту</Button>
            </FormItem>
            <FormItem Label="Период работы карты">
                <DatePicker DefaultPickerValue="DateTime.Now" @bind-Value="@context.CardValidityPeriod" />
            </FormItem>
        </Form>
    ;
    }

    private ModalRef _cardReadingModalRef;
    private bool _isReadingCard = false;
    private string _scannedCardNumber = "";

    private void ReadingCard()
    {
        _isReadingCard = true;

        _cardReadingModalRef = ModalService.CreateModal(new ModalOptions
        {
            Title = "Считывание карты",
            Content = CardReadingTemplate(),
            Width = 400,
            Closable = true,
            MaskClosable = true,
            DestroyOnClose = true,
            Footer = null,
            OnCancel = async e =>
            {
                _isReadingCard = false;
                await _cardReadingModalRef.CloseAsync();
            }
        });
        _ = StartCardReadingMonitor();
    }

    private void CardNumberFormating()
    {
        string cardNumber = pupil.CardNumber;
        int i = cardNumber.Length;
        if (i < 12)
        {
            cardNumber = cardNumber.PadLeft(12, '0');
        }
        cardNumber = cardNumber + "01";
        string reversed = ReverseByPairs(cardNumber);
        byte[] byteArray = Convert.FromHexString(reversed);
        byte crcData = CRC8.Calculate(byteArray);
        pupil.CardNumber = $"{crcData:X2}" + cardNumber;
    }

    private int[] HexToByteArray(string hexStr)
    {
        byte[] byteArray = Convert.FromHexString(hexStr);
        int[] BytesInDexArray = new int[byteArray.Length];
        foreach (byte b in byteArray)
        {
            int i = 0;
            BytesInDexArray[i] = b;
            i++;
        }
        BytesInDexArray = BytesInDexArray.Reverse().ToArray();
        return BytesInDexArray;
    }

    private async Task StartCardReadingMonitor()
    {
        string previousValue = "";
        int unchangedCount = 0;

        while (_isReadingCard)
        {
            await Task.Delay(100);

            if (_scannedCardNumber != previousValue)
            {
                previousValue = _scannedCardNumber;
                unchangedCount = 0;
            }
            else if (!string.IsNullOrEmpty(_scannedCardNumber))
            {
                unchangedCount++;
                if (unchangedCount >= 3)
                {
                    if (_encoding == DEX)
                    {
                        pupil.CardNumber = _scannedCardNumber;
                        await CloseReadingCardModal();
                    }
                    else
                    {
                        pupil.CardNumber = _scannedCardNumber;
                        CardNumberFormating();
                        await CloseReadingCardModal();
                        break;
                    }
                }
            }
        }
    }

    private async Task CloseReadingCardModal()
    {
        await Task.Delay(200);
        _isReadingCard = false;
        await _cardReadingModalRef.CloseAsync();
        if (_inputCardNumber == null)
            await _inputCardNumberEdit.Focus(FocusBehavior.FocusAtFirst);
        else
            await _inputCardNumber.Focus(FocusBehavior.FocusAtFirst);
    }

    RenderFragment CardReadingTemplate()
    {
        _scannedCardNumber = "";
        return
        @<div>
            <p>Поднесите карту к считывателю...</p>
            <div style="text-align: center; margin: 20px 0;">
                <Icon Type="credit-card" Style="font-size: 48px; color: #1890ff;" />
            </div>
            <Alert Message="Ожидание карты..." Type="AlertType.Info" />

            <div>
                <Input @bind-Value="@_scannedCardNumber" AutoFocus="true" />
            </div>
        </div>
        ;
    }
    #endregion
    private string ReverseByPairs(string input)
    {
        StringBuilder sb = new StringBuilder();
        for (int i = input.Length - 2; i >= 0; i -= 2)
        {
            sb.Append(input[i]);
            sb.Append(input[i + 1]);
        }
        return sb.ToString();
    }
    #region DeletePupil
    async Task DeletePupil(Pupils delPupil)
    {
        if (!await Comfirm($"Вы уверены что хотите удалить данную запись?"))
            return;

        var entity = RpcClientContext.Pupils.FirstOrDefault(p => p.PupilsId == delPupil.PupilsId);
        if (entity != null)
        {
            RpcClientContext.Pupils.Remove(entity);
            await RpcClientContext.SaveChangesAsync();
        }
        _pupilsDataSource = _pupilsDataSource
            .Where(p => p.PupilsId != delPupil.PupilsId) 
            .ToList();
        _pupilsTotal = _pupilsDataSource.Count;
        StateHasChanged();
        _pupilsTable.ReloadData();
    }

    private async Task<bool> Comfirm(string message)
    {
        return await ComfirmService.Show(message, "Confirm", ConfirmButtons.YesNo, ConfirmIcon.Warning) == ConfirmResult.Yes;
    }
    #endregion

    #region EditPupil
    private Input<string> _inputCardNumberEdit;
    ModalRef<bool> editModelRef = default;
    IForm editPupilForm = default;

    void EditPupil(Pupils editPupil)
    {
        editModelRef = ModalService.CreateModal<bool>(new()
        {
            Title = "Редактирование ученика",
            Content = EditFormTemplate(editPupil),
            OnOk = async (e) =>
            {
                if (!editPupilForm.Validate())
                {
                    return;
                }

                var entity = RpcClientContext.Pupils.FirstOrDefault(p => p.PupilsId == editPupil.PupilsId);
                if (entity != null)
                {
                    entity.SurnamePupil = editPupil.SurnamePupil;
                    entity.NamePupil = editPupil.NamePupil;
                    entity.PatronymicPupil = editPupil.PatronymicPupil;
                    entity.ClassNumber = editPupil.ClassNumber;
                    entity.CardNumber = editPupil.CardNumber;
                    entity.CardValidityPeriod = editPupil.CardValidityPeriod;
                    await RpcClientContext.SaveChangesAsync();
                    editModelRef.SetConfirmLoading(true);
                    var index = _pupilsDataSource.FindIndex(x => x.PupilsId == editPupil.PupilsId);
                    _pupilsDataSource[index] = entity;
                }

                await Task.Delay(1000);
                await editModelRef.CloseAsync();
                _pupilsTable.ReloadData();
                StateHasChanged();
            },
            OnCancel = async (e) =>
            {
                if (editPupilForm.IsModified && (!await Comfirm("Данные которые вы изменили не будут сохранены. Вы уверены что хотите выйти?")))
                {
                    return;
                }
                await editModelRef.CloseAsync();
            }
        });
    }

    private RenderFragment EditFormTemplate(Pupils editPupil)
    {
        return @<Form @ref="editPupilForm" Model="editPupil" OnFinish="() => editModelRef.OkAsync(true)">
            <FormItem Label="Фамилия">
                <Input Placeholder="Введите фамилию ученика" @bind-Value="@context.SurnamePupil" />
            </FormItem>
            <FormItem Label="Имя">
                <Input Placeholder="Введите имя ученика" @bind-Value="@context.NamePupil" />
            </FormItem>
            <FormItem Label="Отчество">
                <Input Placeholder="Введите отчество ученика" @bind-Value="@context.PatronymicPupil" />
            </FormItem>
            <FormItem Label="Номер класса">
                <AutoComplete Placeholder="Введите класс ученика" @bind-Value="@context.ClassNumber"
                              AllowFilter Options="@ClassNumber"
                              FilterExpression="@((option, value) => option.Label.Contains(value ?? "", StringComparison.InvariantCultureIgnoreCase))" />
            </FormItem>
            <FormItem>
                Выберите формат считывания карты:
                <br />
                <RadioGroup @bind-Value="@_encoding">
                    <Radio Value="HEX">HEX</Radio>
                    <Radio Value="DEX">DEX</Radio>
                </RadioGroup>
            </FormItem>
            <FormItem Label="Номер карты">
                <Input Placeholder="Считайте карту" ReadOnly @ref="@_inputCardNumberEdit" @bind-Value="@context.CardNumber" />
                <Button OnClick="@(() => ReadingCard())" Type="ButtonType.Primary">
                    Считать карту
                </Button>
            </FormItem>
            <FormItem Label="Период работы карты">
                <DatePicker @bind-Value="@context.CardValidityPeriod" />
            </FormItem>
        </Form>;
    }
    #endregion
    RenderFragment AlertError()
    {
        return
        @<Alert Type="AlertType.Error" Closable Message="Ошибка" Description="Ошибка подключения к серверу. Убедитесь, что CoreOrion подключён." ShowIcon="true"></Alert>
        ;
    }
    RenderFragment AlertSuccess()
    {
        return
        @<Alert Type="AlertType.Success" Closable Message="Успех" Description="Вы успешно вошли в приложение" ShowIcon="true"></Alert>
        ;
    }
}